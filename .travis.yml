language: cpp
compiler: gcc
dist: bionic
services:
        - xvfb

addons:
        sonarcloud:
                organization: "squinky86"
                token:
                        secure: "W6T7CJ4wBpP4kFNUjHbt+z+6nKwMbu/dVLhSJiUqZGGjrz6yOLOoyGElRtiUkIrXv9KBj2L64ssOV+HoQCPkclJh9uQuK+cH7NknB1y/ds+Ai5KZOrP/1LSz03ut8GvvIjabf+toEVdSo9k99VsRcWJ79m+lnBgglyng5OzaD0E0fE46qlRlmv2fu9Lvz2OZg3Hj2IlxobF2IzBmH8OYrMjTNxN0fPVluGjMo9ulNg8aK/FqQ4L7pcmx9nCXZ/LQpxmhp2AdH14KyQ7nYWG31km90emTgy+HYzVwihV9MY+/tcpDEmWuTLpb5dWEe+Lnxo/YTxbGZDXu3hmAnwE0SIxUKzYOYDuCWDK6F03oqJBn8JwzukRaxAg+J3TMGWEeHQlAX2oQITTnrcjK7qDS6ii+fxeiEN4ZjwL2CvTMepkzn9bosOOCtGBbrEpoJXaiU9LOaQgvz14QDYEYsfm7YRpl18UDmwPTSq0rHAVwvaspAe+pof0jiz5OTuSo2Haj+vxZUjk8S2gmb6Iw87Zu+wINfFkDj2BWzj6FimiICvoY0btYadvbjEH7tRwm1I+m9NjIJRjjlu1SLlNP6ghSmk6NtErC3Sv4fBsC/X8jGb1VNWVWawQSsnIiyusd0LIt8oPoHlH6Sj7RSRb24Xd2F+TwQyjHyWCN3O+t/EBmY9E="

before_install:
 - sudo apt-get update -qq
 - sudo apt-get install qtbase5-dev qt5-qmake qt5-default libqt5sql5-sqlite
 - sudo apt-get install libtidy-dev libzip-dev zlib1g-dev
 - sudo apt-get install texlive-luatex texlive-latex-recommended texlive-latex-extra texlive-fonts-extra texlive-fonts-extra-links texlive-bibtex-extra biber
 - sudo apt-get install libdevel-cover-perl
 - pushd /tmp && wget https://github.com/jmcnamara/libxlsxwriter/archive/RELEASE_1.0.0.tar.gz && tar -zxf RELEASE_1.0.0.tar.gz && popd
 - pushd /tmp/libxlsxwriter-RELEASE_1.0.0 && make && sudo make install PREFIX=/usr && popd
 - pip install --user cpp-coveralls
 - cpanm --sudo --quiet --notest Devel::Cover::Report::Kritika

script:
 - for x in `find /home/travis/.sonar/cache -name "libinterceptor-x86_64.so"`; do cp ${x} ${x/x86_64/haswell}; done
 - echo "DEFINES += USE_TESTS" >> STIGQter.pro
 - qmake STIGQter.pro
 - sed -i -e 's:-O2:-O0 -fprofile-arcs -ftest-coverage -fno-exceptions -fno-inline:g' -e 's:-Wl,-O1:-Wl,-O1 -lgcov --coverage:g' Makefile
 - build-wrapper-linux-x86-64 --out-dir bw-output make --quiet -j3
 - pushd doc && ./build.sh && popd
 - ./STIGQter tests > STIGQter.tests &
 - while [ ! -z "`pgrep STIGQter`" ]; do sleep 10 && tail -n 1 STIGQter.tests; done
 - tail -n 100 STIGQter.tests

after_success:
 - for x in src/*.cpp; do LC_ALL=en gcov --branch-probabilities --branch-counts ${x} -o .; done
 - sonar-scanner -Dsonar.cfamily.build-wrapper-output=bw-output
 - coveralls --gcov-options '\-lp'
 - gcov2perl *.gcov >> STIGQter.tests
 - tail -n 100 STIGQter.tests
 - cover -ignore_re=^/ -ignore_re=^t -report kritika >> STIGQter.tests
 - tail -n 100 STIGQter.tests
 - bash <(curl -s https://codecov.io/bash) >> STIGQter.tests
 - tail -n 100 STIGQter.tests
